name: ğŸ§ª Tests BDD AutomatisÃ©s

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Tests quotidiens Ã  6h00 UTC
    - cron: '0 6 * * *'

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # Tests de smoke rapides
  smoke-tests:
    name: ğŸš€ Tests de Smoke
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ Installation des dÃ©pendances BDD
      run: |
        cd bdd
        pip install -r requirements.txt
        
    - name: ï¿½ CrÃ©ation rÃ©pertoire rapports
      run: |
        mkdir -p reports/screenshots
        
    - name: ï¿½ğŸ”§ Configuration Chrome
      uses: browser-actions/setup-chrome@latest
      
    - name: âš¡ ExÃ©cution tests de smoke
      run: |
        cd bdd
        behave --tags=@smoke --format=json --outfile=../reports/smoke-results.json
      env:
        TEST_ENV: staging
        HEADLESS: true
        
    - name: ğŸ“Š Upload des rÃ©sultats
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: smoke-test-results
        path: reports/

  # Tests complets par feature
  feature-tests:
    name: ğŸ¯ Tests par Feature
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: smoke-tests
    if: success()
    
    strategy:
      fail-fast: false
      matrix:
        feature: [
          'authentication',
          'profile', 
          'season',
          'challenges',
          'scoring',
          'ui'
        ]
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ Installation des dÃ©pendances
      run: |
        cd bdd
        pip install -r requirements.txt
        
    - name: ï¿½ CrÃ©ation rÃ©pertoire rapports
      run: |
        mkdir -p reports/screenshots
        
    - name: ï¿½ğŸ”§ Configuration navigateur
      uses: browser-actions/setup-chrome@latest
      
    - name: ğŸ§ª Tests ${{ matrix.feature }}
      run: |
        cd bdd
        behave --tags=@${{ matrix.feature }} \
               --format=json \
               --outfile=../reports/${{ matrix.feature }}-results.json
      env:
        TEST_ENV: staging
        HEADLESS: true
        
    - name: ğŸ“¸ Upload captures d'Ã©cran
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: screenshots-${{ matrix.feature }}
        path: reports/screenshots/
        
    - name: ğŸ“Š Upload rÃ©sultats de test
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.feature }}
        path: reports/${{ matrix.feature }}-results.json

  # Tests d'intÃ©gration end-to-end
  e2e-tests:
    name: ğŸ”„ Tests End-to-End
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: feature-tests
    if: success()
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: vacances_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸŸ¢ Configuration Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: ğŸ“¦ Installation dÃ©pendances frontend
      run: |
        cd frontend
        npm ci
        
    - name: ğŸ—ï¸ Build de l'application
      run: |
        cd frontend
        npm run build
        
    - name: ğŸš€ DÃ©marrage serveur local
      run: |
        cd frontend
        npm run preview &
        sleep 10
      env:
        PORT: 3000
        
    - name: ğŸ“¦ Installation dÃ©pendances BDD
      run: |
        cd bdd
        pip install -r requirements.txt
        
    - name: ï¿½ CrÃ©ation rÃ©pertoire rapports
      run: |
        mkdir -p reports/screenshots
        
    - name: ï¿½ğŸ”§ Configuration Chrome
      uses: browser-actions/setup-chrome@latest
      
    - name: ğŸ§ª Tests E2E complets
      run: |
        cd bdd
        behave --format=html --outfile=../reports/e2e-report.html \
               --format=json --outfile=../reports/e2e-results.json
      env:
        TEST_ENV: dev
        BASE_URL: http://localhost:3000
        HEADLESS: true
        DATABASE_URL: postgresql://postgres:test_password@localhost/vacances_test
        
    - name: ğŸ“Š Upload rapport E2E
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-report
        path: reports/e2e-report.html
        
    - name: ğŸ“¸ Upload captures Ã©checs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: e2e-screenshots
        path: reports/screenshots/

  # Tests de performance et charge
  performance-tests:
    name: âš¡ Tests de Performance
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: smoke-tests
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[perf]')
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“¦ Installation dÃ©pendances
      run: |
        cd bdd
        pip install -r requirements.txt
        
    - name: ğŸ“ CrÃ©ation rÃ©pertoire rapports
      run: |
        mkdir -p reports/screenshots
        
    - name: âš¡ Tests de performance
      run: |
        cd bdd
        behave --tags=@performance \
               --format=json \
               --outfile=../reports/performance-results.json
      env:
        TEST_ENV: staging
        HEADLESS: true
        
    - name: ğŸ“Š Analyse des performances
      run: |
        python -c "
        import json
        with open('reports/performance-results.json') as f:
            results = json.load(f)
        # Analyse basique des temps de rÃ©ponse
        print('ğŸ“ˆ RÃ©sultats de performance gÃ©nÃ©rÃ©s')
        "
        
    - name: ğŸ“Š Upload rÃ©sultats performance
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-results
        path: reports/performance-results.json

  # GÃ©nÃ©ration du rapport final
  generate-report:
    name: ğŸ“‹ GÃ©nÃ©ration Rapport Final
    runs-on: ubuntu-latest
    needs: [smoke-tests, feature-tests, e2e-tests]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download tous les artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        
    - name: ğŸ Configuration Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ“Š GÃ©nÃ©ration rapport consolidÃ©
      run: |
        python .github/scripts/generate_test_report.py artifacts/ reports/
        
    - name: ğŸ“¤ Upload rapport final
      uses: actions/upload-artifact@v4
      with:
        name: consolidated-test-report
        path: reports/
        
    - name: ğŸ’¬ Commentaire PR avec rÃ©sultats
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          // Lecture du rÃ©sumÃ© des tests
          let comment = '## ğŸ§ª RÃ©sultats des Tests BDD\n\n';
          
          // Status des tests
          const smokePassed = '${{ needs.smoke-tests.result }}' === 'success';
          const featuresPassed = '${{ needs.feature-tests.result }}' === 'success';
          const e2ePassed = '${{ needs.e2e-tests.result }}' === 'success';
          
          comment += `| Test Suite | Status |\n`;
          comment += `|------------|--------|\n`;
          comment += `| ğŸš€ Smoke Tests | ${smokePassed ? 'âœ…' : 'âŒ'} |\n`;
          comment += `| ğŸ¯ Feature Tests | ${featuresPassed ? 'âœ…' : 'âŒ'} |\n`;
          comment += `| ğŸ”„ E2E Tests | ${e2ePassed ? 'âœ…' : 'âŒ'} |\n\n`;
          
          if (!smokePassed || !featuresPassed || !e2ePassed) {
            comment += 'âš ï¸ **Des tests ont Ã©chouÃ©.** Consultez les artifacts pour plus de dÃ©tails.\n\n';
          } else {
            comment += 'âœ¨ **Tous les tests sont passÃ©s !** L\'application est prÃªte.\n\n';
          }
          
          comment += 'ğŸ“Š [Voir les rapports dÃ©taillÃ©s dans les artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # Notification des rÃ©sultats
  notify:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: [smoke-tests, feature-tests, e2e-tests]
    if: always() && (failure() || success())
    
    steps:
    - name: ğŸ“§ Notification de succÃ¨s
      if: needs.smoke-tests.result == 'success' && needs.feature-tests.result == 'success' && needs.e2e-tests.result == 'success'
      run: |
        echo "âœ… Tous les tests BDD sont passÃ©s avec succÃ¨s!"
        echo "ğŸ‰ L'application Vacances GamifiÃ©es est prÃªte pour le dÃ©ploiement."
        
    - name: ğŸš¨ Notification d'Ã©chec
      if: needs.smoke-tests.result == 'failure' || needs.feature-tests.result == 'failure' || needs.e2e-tests.result == 'failure'
      run: |
        echo "âŒ Des tests BDD ont Ã©chouÃ©."
        echo "ğŸ” VÃ©rifiez les logs et les captures d'Ã©cran dans les artifacts."
        exit 1
